library(stats) #Instalar i carregar paquet.
library(tibble) #Instalar i carregar paquet.
install.packages("forecast")
library(forecast)

ventana <- 5

#################################
##Importem dades Ibex-35 mensuals i apliquem la funció.
#################################
datos<-c(3000, 2841.6, 2762.4, 2484.5, 2643.7, 2765, 2867.8, 2834.5, 2511.3, 2060.7, 2303.2, 2289.2, 2248.8, 2333.7, 2622.8, 2789, 2755.3, 2862.3,2752.8,2708.4,2766.18,2830.47,2765.08,2610.56,2603.3,2711.79,2857.18,2750.42,2610.56,2813.89,2553.82,2289.85,2160.96,2032.13,2110.77, 2342.73, 2344.57, 2529.3,2576.04,2658.49,2686,2834.36,2854.6,2981.16,3360.2,3177.33,3449.63,3280.1,3615.22,3980.53,3739.68,3489.08,3520.73,3512.59,3200.71,3364.16,3337.01,3176.63,3194.52,3287.09,3087.68,3040.06,3024.54,2931.7,3091.86,3226.49,3219.05,3373.39,3432.75,3376.77,3277.33,3510.12,3630.76,3734.49,3915.52,3857.12,4082.9,4111.66,4264.1,3979.35,4025.47,4215.57,4306.74,4667.8,5154.77,5327.42,5305.43,5520.68,5909.33,6300.82,6884.56,6810.89,6532.33,7269.72,6380.39,6932.1,7255.4,7958.99,8900.09,10209.16,10025.68,10005.72,10146.4,10493.7,8264.7,7676.5,8800,9645.5,9836.6,9878.8,9997.3,9740.7,9975.4,10072.3,10218.6,9391.9,9806.1,9525.4,9741.5,10958.1,11641.4,10835.1,12585.8,11935,11467.9,10688.5,10581.3,10531.6,10884.7,10950,10363.1,9214.5,9109.8,10116,9551.4,9308.3,9761,9500.7,8878.4,8480,8321.1,7314,7774.3,8364.7,8397.6,8050.4,8135.5,8249.7,8154.4,7949.9,6913,6249.3,6435.7,5431.7,6139.4,6685.6,6036.9,5947.7,5999.4,5870.5,6489.5,6508.5,6862,7061.7,7111.3,6703.6,7129.5,7252.5,7737.2,7929.9,8249.4,8018.1,8109.5,7959.3,8078.3,7919.3,7869.5,8029.2,8418.3,8693,9080.8,9223.9,9391,9258.8,9001.6,9427.1,9783.2,10115.6,10008.9,10813.9,10493.8,10557.8,10733.9,11104.3,11740.7,11854.3,11892.5,11340.5,11548.1,11818,12144.7,12934.7,13753,13849.3,14146.5,14553.2,14248.4,14641.7,14374.6,15329.4,14892,14802.4,14479.8,14576.5,15890.5,15759.9,15182.3,13229,13170.4,13269,13798.3,13600.9,12046.2,11881.3,11707.3,10987.5,9116,8910.6,9195.8,8450.4,7620.9,7815,9038,9424.3,9787.8,10855.1,11365.1,11756.1,11414.8,11644.7,11940,10947.7,10333.6,10871.3,10492.2,9359.4,9263.4,10499.8,10187,10514.5,10812.9,9267.2,9859.1,10806,10850.8,10576.5,10878.9,10476,10359.9,9630.7,8718.6,8546.6,8954.9,8449.5,8566.3,8509.2,8465.9,8008,7011,6089.8,7102.2,6738.1,7420.5,7708.5,7842.9,7934.6,8167.5,8362.3,8230.3,7920,8419,8320.6,7762.7,8433.4,8290.5,9186.1,9907.9,9837.6,9916.7,9920.2,10114.2,10340.5,10459,10798.7,10923.5,10707.2,10728.8,10825.5,10477.8,10770.7,10279.5,10403.3,11178.3,11521.1,11385,11217.6,10769.5,11180.7,10259,9559.9,10360.7,10386.9,9544.2,8815.8,8461.4,8723.1,9025.7,9034,8163.3,8587.2,8716.8,8779.4,9143.3,8688.2,9532.1,9315.2,9555.5,10462.9,10715.8,10880,10444.5,10502.2,10299.5,10381.5,10523.5,10211,10043.9,10451.5,9840.3,9600.4,9980.6,9465.5,9622.7,9870.7,9399.1,9389.2,8893.5,9077.2,8539.9,9056.7,9277.7,9240.3,9570.6,9004.2,9198.8,8971,8812.9,9244.6,9257.5,9352,9549.2,9367.9,8741.5,6785.4,6922.3,7096.5,7231.4,6877.4,6969.5,6716.6,6452.2,8076.9,8073.7,7757.5,8225,8580,8815,9148.9,8821.2,8675.7,8846.6,8796.3,9057.7,8305.1,8713.8,8612.8,8479.2,8445.1,8584.2,8851.5,8098.7,8156.2,7886.1,7366.8,7956.5,8363.2,8229.1,9034,9394.6,9232.5,9241,9050.2,9593,9641.5,9505.9,9428,9017.3,10058.2,10102.1,10077.7,10001.3)
datos_suavizados<-c(2743.28, 2700.9, 2651.69, 2606.69, 2573.55, 2557.72, 2554.12, 2558.94, 2569.27, 2564.16, 2571.12, 2584.78, 2599.73, 2610.6, 2612.87, 2611.75, 2612.44, 2620.17, 2640.12, 2665.17, 2688.2, 2702.07, 2701.47, 2689.07, 2667.58, 2639.67, 2608.04, 2575.37, 2544.36, 2517.7, 2497.21, 2483.85, 2478.56, 2482.28, 2495.97, 2520.56, 2557.01, 2606.25, 2667.25, 2737.15, 2813.11, 2892.29, 2971.83, 3048.89, 3120.62, 3184.18, 3238.77, 3284.46, 3321.32, 3349.39, 3368.75, 3379.47, 3381.59, 3375.2, 3360.62, 3340.2, 3316.28, 3291.18, 3267.24, 3246.8, 3232.2, 3225.76, 3228.85, 3240.73, 3260.72, 3288.09, 3322.15, 3362.17, 3407.45, 3457.27, 3512.34, 3573.04, 3639.79, 3712.99, 3793.05, 3880.36, 3975.34, 4078.39, 4191.69, 4318.39, 4461.66, 4624.67, 4799.31, 4977.48, 5151.08, 5312, 5472.36, 5642.89, 5834.29, 6057.29, 6321.67, 6637.24, 6967.02, 7274.03, 7569.31, 7862.11, 8013.31, 8131.87, 8252.35, 8420.64, 8610.47, 8795.61, 8986.57, 9173.64, 9347.73, 9499.74, 9612.82, 9671.05, 9657.8, 9603.21, 9587.54, 9643.04, 9707.5, 9867.08, 10144.3, 10344.3, 10446.8, 10503.6, 10553.3, 10597.9, 10646.3, 10706.8, 10735.1, 10694.9, 10638.4, 10618.5, 10631.5, 10623.6, 10541, 10424.3, 10317.4, 10079.6, 9862.18, 9641.65, 9440.03, 9292.39, 9164.01, 9013.22, 8845.85, 8720.25, 8656.01, 8584.03, 8457.78, 8287.33, 8082.79, 7854.22, 7637.77, 7466.37, 7324.46, 7196.5, 7098.97, 7003.04, 6879.83, 6770.25, 6697.64, 6637.77, 6566.44, 6498.19, 6461.75, 6463.32, 6509.11, 6605.31, 6743.99, 6891.19, 7012.93, 7123.75, 7247.9, 7377.55, 7504.91, 7622.16, 7721.49, 7812.7, 7905.57, 8009.87, 8132.11, 8264.6, 8399.64, 8529.54, 8646.61, 8757.28, 8868, 8985.18, 9119.84, 9273.26, 9446.7, 9641.46, 9846.02, 10048.9, 10238.6, 10403.7, 10556.1, 10711.4, 10884.8, 11091.8, 11322.2, 11566, 11813, 12053.1, 12292.1, 12531, 12771.1, 13013.4, 13227.7, 13396.6, 13559, 13753.7, 13987.5, 14243.4, 14444.4, 14513.8, 14507.3, 14505.9, 14487.3, 14429, 14337, 14201.6, 14012.9, 13761.2, 13446, 13098.6, 12750.1, 12375.2, 11963.3, 11536.3, 11116, 10784.1, 10593.8, 10466.1, 10321.8, 10185.2, 10092.7, 10051.9, 10032.3, 10003.1, 10004.7, 10067.8, 10147.2, 10197.5, 10267.9, 10392.9, 10535.1, 10657.2, 10709, 10668.7, 10601.3, 10571.8, 10551.5, 10499.9, 10422.3, 10362.1, 10329.9, 10264.7, 10151.4, 10051.1, 10005.3, 9960.62, 9864.15, 9734.47, 9583.39, 9435.61, 9315.79, 9161.77, 8932.3, 8679.8, 8456.64, 8269.63, 8103.81, 7977.61, 7909.49, 7872.2, 7842.54, 7816.95, 7791.85, 7763.67, 7742.4, 7744.87, 7787.9, 7888.29, 8043.82, 8231.33, 8427.65, 8609.64, 8766.16, 8907.8, 9045.15, 9188.82, 9339.31, 9493.09, 9646.65, 9796.46, 9947.86, 10092.6, 10222.4, 10329.1, 10419.3, 10518.5, 10613.7, 10691.5, 10755.9, 10798.9, 10812.5, 10788.7, 10745.3, 10710.4, 10649.1, 10526.7, 10392.8, 10288.5, 10192.3, 10083.1, 9966.18, 9832.17, 9671.65, 9514.1, 9378.02, 9264.65, 9175.24, 9111.03, 9094.7, 9122.98, 9150.27, 9193.87, 9296.23, 9415.11, 9508.32, 9595.91, 9696.22, 9800.86, 9901.41, 9989.46, 10057.6, 10109.5, 10148.7, 10178.8, 10199.3, 10188.1, 10123.3, 10025.2, 9924.83, 9828.37, 9741.83, 9671.27, 9610.04, 9553.24, 9495.93, 9433.2, 9370.01, 9310.31, 9258.06, 9217.22, 9185.22, 9163.67, 9154.18, 9158.36, 9134.24, 9028.94, 8893.27, 8778.02, 8662.78, 8539.79, 8401.29, 8239.53, 8103.76, 8033.33, 7985.59, 7917.87, 7848.93, 7804.08, 7771.37, 7738.83, 7707.25, 7720.96, 7824.32, 7957.98, 8063.44, 8153.39, 8240.53, 8337.58, 8457.92, 8557.94, 8594.02, 8604.57, 8626.24, 8634.22, 8603.73, 8547.22, 8487.68, 8435.4, 8400.66, 8393.75, 8410.05, 8444.14, 8490.6, 8543.99, 8600.44, 8655.36, 8704.17, 8742.28, 8797.1, 8897.77, 9020.56, 9141.71, 9267.05, 9354.75, 9444.35, 9525.3, 9583.81, 9622.59, 9645.35, 9657.28, 9665.87)


##############
##REMOSTREIG##
##############
library(data.table)#Instalar i carregar paquet.

#Funció remostreig.
mi.remuestra <- function(datos_ob, datos_ob_suav) {
  size.tmp <- length(datos_ob)
  residus.tmp <- datos_ob - datos_ob_suav
  residus.adims.tmp <- residus.tmp / datos_ob_suav
  remuestra.adims.tmp <- sample(residus.adims.tmp, size.tmp, replace = TRUE)
  reconstruidos.tmp <- datos_ob_suav + remuestra.adims.tmp * datos_ob_suav
  return(reconstruidos.tmp)
}


#Gràfica amb el model ARIMA(2,0,0), millor model segons l'error quadràtic mitjà i la desviació.
modelos_arima <- list(
  c(2, 0, 0))


plot(datos, type = "l", col = "black", xlim = c(1, length(datos) + ventana), ylim = range(c(datos, datos_suavizados, datos)), 
     ylab = "IBEX35", xlab = "Temps")


#Realitzar el remostreig i calcular mètriques per a cada model ARIMA.
resultats_rem1<- data.frame(Realizacion=integer(), Modelo=character(), MSE=numeric(), Desviacio=numeric(), AIC=numeric(), BIC=numeric(), stringsAsFactors=FALSE)

for (i in 1:100) {
  rem1.nvl <- mi.remuestra(datos, datos_suavizados)
  lines(rem1.nvl, col="cyan")
  
  
  for (modelo_arima in modelos_arima) {
    modelo <- tryCatch(
      arima(rem1.nvl, order = modelo_arima),
      error = function(e) NULL
    )
    
    if (!is.null(modelo)) {
      prediccion <- tryCatch(
        predict(modelo, n.ahead = ventana),
        error = function(e) NULL
      )
      
            tiempo_prediccion <- seq(length(datos) + 1, length(datos) + ventana)
        lines(tiempo_prediccion, prediccion$pred, col = "pink")
      }
    }
  }
 
# Añadir la visualización final de los datos
tmp.pred2 <- forecast(modelo2, h = ventana)   
lines(c(1:length(datos_suavizados), length(datos_suavizados) + 1:length(tmp.pred2$mean)), c(datos_suavizados, tmp.pred2$mean), col = "#9ACD32")
lines(datos, col = "black")
lines(datos_train, col = "gray")
lines(datos_suavizados, col = "blue")



###############################
#Crear intervals de predicció.#
###############################
modelos_arima <- list(
  c(2, 0, 0))


plot(datos, type = "l", col = "black", xlim = c(1, length(datos) + ventana), ylim = range(c(datos, datos_suavizados, datos, datos_suavizados)), 
     ylab = "IBEX35", xlab = "Temps")

lines(datos_suavizados, col = "blue")

for (i in 1:100) {
  rem1.nvl <- mi.remuestra(datos, datos_suavizados)
  lines(rem1.nvl, col="cyan")
  
  
  for (modelo_arima in modelos_arima) {
    modelo <- tryCatch(
      arima(rem1.nvl, order = modelo_arima),
      error = function(e) NULL
    )
    
    if (!is.null(modelo)) {
      forecasted <- tryCatch(
        forecast(modelo, h = ventana, level = c(20,30,40,50,60,70,80,85,90,95,99)),
        error = function(e) NULL
      )
         
      }
    }
  }


print(forecasted)
plot(forecasted)

#Dibuixar intervals de confiança amb la sèrie de dades observades per visualitzar els intervals de confiança.
plot(datos, type = "l", col = "black", 
     xlim = c(1, length(datos) + ventana), 
     ylim = range(c(datos, forecasted$mean, forecasted$lower, forecasted$upper)), 
     xlab = "Temps", ylab = "IBEX35",
     main = "Predicció ARIMA a 5 mesos amb intervals de confiança", cex.main=2.2)

lines((length(datos) + 1):(length(datos) + ventana), forecasted$mean, col = "#9ACD32", lwd = 2)


colors <- colorRampPalette(c("purple", "grey"))(length(forecasted$level))
alpha <- seq(0.8, 0.1, length.out = length(forecasted$level))  # Degradado de opacidad


for (i in seq_along(forecasted$level)) {
  lower_bound <- forecasted$lower[,i]
  upper_bound <- forecasted$upper[,i]
  

  polygon(c((length(datos) + 1):(length(datos) + ventana), rev((length(datos) + 1):(length(datos) + ventana))),
          c(lower_bound, rev(upper_bound)),
          col = rgb(col2rgb(colors[i])[1]/255, col2rgb(colors[i])[2]/255, col2rgb(colors[i])[3]/255, alpha[i]), 
          border = NA) 

  lines((length(datos) + 1):(length(datos) + ventana), lower_bound, col = rgb(0, 0, 1, alpha[i] * 0.5), lty = 2)
  lines((length(datos) + 1):(length(datos) + ventana), upper_bound, col = rgb(0, 0, 1, alpha[i] * 0.5), lty = 2)
}

lines((length(datos) + 1):(length(datos) + ventana), forecasted$mean, col = "#9ACD32", lwd = 2)
lines(datos, col="black")
lines(datos_train, col="gray")
lines(datos_suavizados, col="blue")
legend("bottomright", legend = c("Dades observades", "Serie Suavitzada", "Prediccions mitjanes"), col = c("black", "blue", "#9ACD32"), lty = c(1, 1, 1), cex = 0.7)










